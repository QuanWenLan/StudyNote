### 业务

##### 如何保持接口幂等性（如何避免重复提交）

产生接口幂等性问题

- 网络波动, 可能会引起重复请求
- 用户重复操作,用户在操作时候可能会无意触发多次下单交易,甚至没有响应而有意触发多次交易应用
- 使用了失效或超时重试机制(Nginx重试、RPC重试或业务层重试等)
- 页面重复刷新
- 使用浏览器后退按钮重复之前的操作,导致重复提交表单
- 使用浏览器历史记录重复提交表单
- 浏览器重复的HTTP请求
- 定时任务重复执行
- 用户双击提交按钮

解决

- 按钮只可以操作一次（前端控制多次提交）

- 功能上允许重复提交，但保证重复提交不会产生动作。请求带上token，根据token来避免重复请求。

- 使用Post/Redirect/Get模式

  在提交后执行页面重定向,这就是所谓的Post-Redirect—Get(PRG)模式,简单来说就是当用户提交连表单后,跳转到一个重定向的信息页面,这样就避免用户按F5刷新导致的重复提交,而且也不会出现浏览器表单重复提交的警告,也能消除按浏览器前进和后退导致同样重复提交的问题。

- 数据库实现

  - 悲观锁

  - 唯一索引：

    使用唯一主键去做防重表的唯一索引,比如使用订单号作为防重表的唯一索引,每一次请求都根据订单号向防重表中插入一条数据,插入成功说明可以处理后面的业务,当处理完业务逻辑之后删除防重表中的订单号数据,后续如果有重复请求,则会因为防重表唯一索引原因导致插入失败,直接返回操作失败,直到第一次请求返回结果,可以看出防重表作用就是加锁的功能。

  - 乐观锁

    如果更新已有数据,可以进行加锁更新,也可以设计表结构时使用乐观锁,通过version来做乐观锁,这样既能保证执行效率,又能保证幂等, 乐观锁的version版本在更新业务数据要自增
    `update table set version = version + 1 where id = #{id} and version = #{version}`

- JVM锁实现

  JVM 锁实现是指通过 JVM 提供的内置锁如 Lock 或者是 synchronized 来实现幂等性。使用 JVM 锁来实现幂等性的一般流程为：首先通过 Lock 对代码段进行加锁操作，然后再判断此订单是否已经被处理过，如果未处理则开启事务执行订单处理，处理完成之后提交事务并释放锁。问题是只适用于单机环境。

- 分布式锁实现

  分布式锁实现幂等性的逻辑是，在每次执行方法之前先判断是否可以获取到分布式锁，如果可以，则表示为第一次执行方法，否则直接舍弃请求即可。

  需要注意的是分布式锁的 key 必须为业务的唯一标识，我们通常使用 [Redis](https://cloud.tencent.com/product/crs?from=10680) 或者 ZooKeeper 来实现分布式锁；如果使用 Redis 的话，则用 set 命令来创建和获取分布式锁，执行示例如下：

  ```sh
  127.0.0.1:6379> set lock true ex 30 nx
  OK # 创建锁成功
  ## ex 是用来设置超时时间的；而 nx 是 not exists 的意思，用来判断键是否存在。如果返回的结果为“OK”，则表示创建锁成功，否则表示重复请求，应该舍弃
  ```

- 缓冲队列

  将请求都快速地接收下来后放入缓冲队列中,后续使用异步任务处理队列中的数据,过滤掉重复的请求,该解决方案优点是同步处理改成异步处理、高吞吐量,缺点则是不能及时地返回请求结果,需要后续轮询得处理结果

##### 如何保持数据一致性

#### es和MySQL使用场景（关系型和非关系型数据库）

##### 关系型数据库

关系型数据库指的是使用关系模型（二维表格模型）来组织数据的数据库。

关系模型可以简单理解为二维表格模型，而一个关系型数据库就是由二维表及其之间的关系组成的一个数据组织。

Oracle、MySQL、Microsoft SQL Server、SQLite、PostgreSQL、IBM DB2

###### 优点

1. 易于维护：都是使用表结构，数据库的ACID属性，大大降低了数据冗余和数据不一致的概率。
2. 使用方便：SQL语言通用。
3. 多个表之间的复杂 SQL 查询。
4. 提供了对事务的支持，能保证系统中事务的正确执行，支持回滚。
5. 存储在磁盘中，安全可靠。

###### 缺点

1. 海量数据的读写效率：磁盘IO是一个很大的瓶颈。
2. 高扩展性和可用性。
   - 固定表结构，灵活度低，无法快速容纳新的数据类型。
   - 数据库难以横向扩展，当一个应用系统的用户量和访问量与日俱增的时候，数据库没有办法像web Server那样简单的通过添加更多的硬件和服务节点来拓展性能和负载能力。
3. 高并发读写能力差：网站类用户的并发型访问非常高，而一台数据库的最大连接数有限。

##### 非关系型数据库（NOSQL）

通常指数据以对象的形式存储在数据库中，而对象之间的关系通过每个对象自身的属性来决定，**常用于存储非结构化的数据**。

1. 面向高性能并发读写的**key-value**数据库

主要特点是具有极高的并发读写性能，例如Redis、Tokyo Cabint等。

2. 面向海量数据访问的**面向文档**数据库

特点是，可以在海量的数据库快速的查询数据。例如MongoDB以及CouchDB。

3. 面向**可拓展的分布式**数据库

解决的主要问题是传统数据库的扩展性上的缺陷。

###### 优点

1. 格式灵活：存储格式可以是 key，value形式，文档形式，图片形式等等，使用灵活，应用场景广泛，而关系型数据库支支持基础类型。
2. 速度快：nosql 可以使用硬盘或者随机存储器作为载体，而关系型数据库只能使用硬盘。
3. 高扩展性
4. 成本低：nosql数据库部署简单，基本都是开源软件。

###### 缺点

但是由于Nosql约束少，所以也不能够像sql那样提供where字段属性的查询。因此适合存储较为简单的数据。有一些不能够持久化数据，所以需要和关系型数据库结合。

1. 没有事务处理，无法保证数据的完整性和安全性。
2. 复杂表关联查询不容易实现。
3. 不支持sql，学习和使用成本较高。
4. 功能没有关系型数据库完善。

#### es如何支持百万数据查询的

##### playframework有什么优势

https://blog.csdn.net/Ellis_li/article/details/103493809

#### 如何自动取消30分钟没有付款的订单？

订单创建成功，提交了事务之后，如果加入延迟队列失败，此时应该怎么处理？

可以将创建订单和订单id加入到延迟队列里的这两个操作放在同一个事务里面去处理，两者都成功则能保证都有数据，否则回滚事务。